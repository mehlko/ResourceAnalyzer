<!DOCTYPE html>
<html>
  <head>
    <title>react-bpmn example</title>

    <!-- app dependency -->
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>

    <!-- modeler distro -->
    <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>

    <style>
      .diagram-container {
        height: 300px;
      }

      .react-bpmn-diagram-container {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>Display BPMN 2.0 Diagrams Using React</h1>

      <div id="diagram" class="diagram-container"></div>
    </div>
    <script type="text/babel">
      function onError(err) {
        console.error('failed to render diagram', err);
      }

      function onLoading() {
        console.log('loading diagram');
      }

      function onShown() {
        console.log('diagram shown');
      }

      class ReactBpmn extends React.Component {
        constructor(props) {
          super(props);

          this.state = {};

          this.containerRef = React.createRef();
        }

        componentDidMount() {
          const { url, diagramXML } = this.props;

          const container = this.containerRef.current;

          this.bpmnViewer = new BpmnJS({ container });

          this.bpmnViewer.on('import.done', (event) => {
            const { error, warnings } = event;

            if (error) {
              return this.handleError(error);
            }

            this.bpmnViewer.get('canvas').zoom('fit-viewport');

            return this.handleShown(warnings);
          });

          if (url) {
            return this.fetchDiagram(url);
          }

          if (diagramXML) {
            return this.displayDiagram(diagramXML);
          }
        }

        componentWillUnmount() {
          this.bpmnViewer.destroy();
        }

        componentDidUpdate(prevProps, prevState) {
          const { props, state } = this;

          if (props.url !== prevProps.url) {
            return this.fetchDiagram(props.url);
          }

          const currentXML = props.diagramXML || state.diagramXML;

          const previousXML = prevProps.diagramXML || prevState.diagramXML;

          if (currentXML && currentXML !== previousXML) {
            return this.displayDiagram(currentXML);
          }
        }

        displayDiagram(diagramXML) {
          this.bpmnViewer.importXML(diagramXML);
        }

        fetchDiagram(url) {
          this.handleLoading();

          fetch(url)
            .then((response) => response.text())
            .then((text) => this.setState({ diagramXML: text }))
            .catch((err) => this.handleError(err));
        }

        handleLoading() {
          const { onLoading } = this.props;

          if (onLoading) {
            onLoading();
          }
        }

        handleError(err) {
          const { onError } = this.props;

          if (onError) {
            onError(err);
          }
        }

        handleShown(warnings) {
          const { onShown } = this.props;

          if (onShown) {
            onShown(warnings);
          }
        }

        render() {
          return (
            <div
              className="react-bpmn-diagram-container"
              ref={this.containerRef}
            ></div>
          );
        }
      }

      ReactDOM.render(
        <div>
          <ReactBpmn
            onLoading={onLoading}
            onShown={onShown}
            onError={onError}
          />
        </div>,
        document.querySelector('#diagram')
      );
    </script>
  </body>
</html>
